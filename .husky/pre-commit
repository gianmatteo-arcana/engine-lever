#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# SmallBizAlly Pre-Commit Hook
# Enforces TDD and testing standards per CLAUDE.md

echo "🚀 Running SmallBizAlly pre-commit checks..."

# CRITICAL: Check package-lock.json sync FIRST (prevents deployment failures)
echo "🔒 Checking package-lock.json sync with package.json..."
npm ci --dry-run > /dev/null 2>&1
if [ $? -ne 0 ]; then
  echo "❌ package-lock.json is out of sync with package.json!"
  echo "🔧 Run 'npm install' to update package-lock.json"
  echo "📦 Then commit both package.json and package-lock.json"
  echo "⚠️  This WILL break Railway deployment if not fixed!"
  exit 1
fi

# 1. Run linter
echo "📝 Running linter..."
npm run lint
if [ $? -ne 0 ]; then
  echo "❌ Linting failed! Fix errors before committing."
  exit 1
fi

# 2. Check TypeScript compilation
echo "🔧 Checking TypeScript compilation..."
npx tsc --noEmit
if [ $? -ne 0 ]; then
  echo "❌ TypeScript compilation failed! Fix type errors before committing."
  exit 1
fi

# 3. Run tests (quick mode for pre-commit)
echo "🧪 Running quick tests..."
npm run test:quick
if [ $? -ne 0 ]; then
  echo "❌ Tests failed! All tests must pass before committing."
  echo "💡 Remember: We are NOT SKIPPING ANY TESTS!!"
  echo "💡 Run 'npm run test:all-e2e' for full E2E test suite"
  exit 1
fi

# 4. Build project
echo "🏗️ Building project..."
npm run build
if [ $? -ne 0 ]; then
  echo "❌ Build failed! Fix build errors before committing."
  exit 1
fi

echo "✅ All pre-commit checks passed! Ready to commit."
echo "🎯 Remember: Everything is a task, everything is configuration!"
