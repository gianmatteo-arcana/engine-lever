#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# SmallBizAlly Pre-Commit Hook
# Enforces TDD and testing standards per CLAUDE.md

echo "ğŸš€ Running SmallBizAlly pre-commit checks..."

# CRITICAL: Check package-lock.json sync FIRST (prevents deployment failures)
echo "ğŸ”’ Checking package-lock.json sync with package.json..."
npm ci --dry-run > /dev/null 2>&1
if [ $? -ne 0 ]; then
  echo "âŒ package-lock.json is out of sync with package.json!"
  echo "ğŸ”§ Run 'npm install' to update package-lock.json"
  echo "ğŸ“¦ Then commit both package.json and package-lock.json"
  echo "âš ï¸  This WILL break Railway deployment if not fixed!"
  exit 1
fi

# 1. Run linter
echo "ğŸ“ Running linter..."
npm run lint
if [ $? -ne 0 ]; then
  echo "âŒ Linting failed! Fix errors before committing."
  exit 1
fi

# 2. Check TypeScript compilation
echo "ğŸ”§ Checking TypeScript compilation..."
npx tsc --noEmit
if [ $? -ne 0 ]; then
  echo "âŒ TypeScript compilation failed! Fix type errors before committing."
  exit 1
fi

# 3. Run tests (quick mode for pre-commit)
echo "ğŸ§ª Running quick tests..."
npm run test:quick
if [ $? -ne 0 ]; then
  echo "âŒ Tests failed! All tests must pass before committing."
  echo "ğŸ’¡ Remember: We are NOT SKIPPING ANY TESTS!!"
  echo "ğŸ’¡ Run 'npm run test:all-e2e' for full E2E test suite"
  exit 1
fi

# 4. Build project
echo "ğŸ—ï¸ Building project..."
npm run build
if [ $? -ne 0 ]; then
  echo "âŒ Build failed! Fix build errors before committing."
  exit 1
fi

echo "âœ… All pre-commit checks passed! Ready to commit."
echo "ğŸ¯ Remember: Everything is a task, everything is configuration!"
